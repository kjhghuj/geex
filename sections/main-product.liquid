{% schema %}
{
  "name": "Product Page",
  "settings": [],
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "specification_item",
      "name": "Manual Specification",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Label",
          "default": "Material"
        },
        {
          "type": "text",
          "id": "content",
          "label": "Value",
          "default": "Connect dynamic source here"
        }
      ]
    }
  ]
}
{% endschema %}

{% assign selected_variant = product.selected_or_first_available_variant %}
{% assign current_media = selected_variant.featured_media | default: product.featured_media %}

<div class="animate-fade-in" id="MainProductSection" data-section-id="{{ section.id }}">
    
    <div class="max-w-7xl mx-auto px-4 py-8 md:py-12">
        <div class="flex items-center space-x-2 text-sm font-medium text-gray-400 mb-6 md:mb-8 flex-wrap">
            <a href="{{ routes.root_url }}" class="hover:text-black transition-colors">Home</a>
            <span>/</span>
            <a href="{{ routes.all_products_collection_url }}" class="hover:text-black transition-colors">Shop</a>
            <span>/</span>
            <span class="text-slate-800">{{ product.title }}</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 lg:gap-24 mb-16 md:mb-24">
            
            <div class="product-gallery sticky top-24 self-start">
                <div 
                    class="relative aspect-square bg-gray-50 rounded-3xl overflow-hidden mb-4 md:mb-6 group cursor-crosshair"
                    id="MainImageWrapper"
                    onmousemove="handleZoom(event)"
                    onmouseleave="resetZoom(event)"
                >
                    {% if current_media != null %}
                        <img 
                            id="MainImage"
                            src="{{ current_media | image_url: width: 1000 }}" 
                            alt="{{ product.title | escape }}" 
                            class="w-full h-full object-contain pointer-events-none transition-transform duration-200 mix-blend-multiply" 
                            width="1000"
                            height="1000"
                        >
                        <div 
                            id="ZoomLens"
                            class="absolute inset-0 opacity-0 group-hover:opacity-100 pointer-events-none bg-no-repeat bg-white mix-blend-normal"
                            style="background-image: url('{{ current_media | image_url: width: 2000 }}'); background-size: 200%; z-index: 10;"
                        ></div>
                    {% else %}
                        {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-cover text-gray-200' }}
                    {% endif %}
                </div>

                {% if product.media.size > 1 %}
                    <div class="grid grid-cols-4 gap-3 md:gap-4" id="ThumbnailGrid">
                        {% for media in product.media limit: 8 %}
                            <div 
                                class="aspect-square rounded-2xl overflow-hidden border cursor-pointer transition-all thumbnail-item relative bg-gray-50
                                {% if media.id == current_media.id %} ring-2 ring-sky-500 border-transparent {% else %} border-transparent hover:border-gray-300 {% endif %}"
                                data-media-id="{{ media.id }}"
                                onclick="changeImage('{{ media | image_url: width: 1000 }}', '{{ media | image_url: width: 2000 }}', this)"
                            >
                                <img 
                                    src="{{ media | image_url: width: 200 }}" 
                                    alt="{{ media.alt | escape }}"
                                    class="w-full h-full object-cover mix-blend-multiply"
                                    width="200"
                                    height="200"
                                >
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="flex flex-col pt-0 md:pt-4">
                <div class="inline-block text-sky-500 font-bold text-xs uppercase tracking-widest mb-3">
                    {{ product.type | upcase }}
                </div>

                <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-slate-900 mb-4 md:mb-6 tracking-tight leading-tight">
                    {{ product.title }}
                </h1>
                
                <div class="mb-8" id="ProductPrice">
                    <div class="flex items-center gap-3 md:gap-4">
                        <span class="text-3xl md:text-4xl font-bold text-slate-900 leading-none tracking-tight">
                            {{ selected_variant.price | money }}
                        </span>

                        {% if selected_variant.compare_at_price > selected_variant.price %}
                            <div class="flex flex-col items-start justify-center space-y-1">
                                {% assign price_float = selected_variant.price | times: 1.0 %}
                                {% assign compare_float = selected_variant.compare_at_price | times: 1.0 %}
                                {% assign discount_ratio = price_float | divided_by: compare_float %}
                                {% assign discount_percentage = 1.0 | minus: discount_ratio | times: 100 | round %}
                                
                                <span 
                                    class="text-xs font-bold px-2 py-0.5 rounded-md leading-tight"
                                    style="background-color: #FEF2F2 !important; color: #DC2626 !important; border: 1px solid #FECACA;"
                                >
                                    -{{ discount_percentage }}% OFF
                                </span>

                                <span 
                                    class="text-sm text-gray-400 font-medium leading-none"
                                    style="text-decoration: line-through !important;"
                                >
                                    {{ selected_variant.compare_at_price | money }}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                {% form 'product', product, id: 'product-form' %}
                    <input type="hidden" name="id" value="{{ selected_variant.id }}" id="VariantIdInput">

                    <div class="bg-white rounded-3xl p-5 md:p-6 border border-gray-100 shadow-sm mb-8 md:mb-10 space-y-6 md:space-y-8">
                        
                        {% unless product.has_only_default_variant %}
                            {% for option in product.options_with_values %}
                                <div class="variant-option-group">
                                    <label class="block text-xs font-bold text-slate-900 uppercase tracking-wide mb-3">{{ option.name }}</label>
                                    <div class="flex flex-wrap gap-2">
                                        {% for value in option.values %}
                                            <div class="relative">
                                                <input 
                                                    type="radio" 
                                                    id="Option-{{ section.id }}-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                                                    name="options[{{ option.name }}]"
                                                    value="{{ value | escape }}"
                                                    class="sr-only variant-radio"
                                                    {% if option.selected_value == value %}checked{% endif %}
                                                    data-option-index="{{ forloop.parentloop.index0 }}"
                                                >
                                                <label 
                                                    for="Option-{{ section.id }}-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                                                    class="variant-label block px-4 py-2 rounded-lg text-sm font-bold cursor-pointer transition-all duration-200
                                                    bg-white border-2 border-gray-200 text-slate-700 shadow-sm hover:border-gray-400 hover:text-slate-900"
                                                >
                                                    {{ value }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endunless %}

                        <div>
                            <label class="block text-xs font-bold text-slate-900 uppercase tracking-wide mb-3">Quantity</label>
                            
                            <div class="flex items-center w-36 bg-gray-50 rounded-full p-1.5 border border-gray-100" x-data="{ qty: 1 }">
                                <button type="button" @click="qty = Math.max(1, qty - 1)" class="w-9 h-9 rounded-full bg-white text-slate-900 shadow-sm border border-gray-100 flex items-center justify-center hover:text-sky-500 hover:border-sky-200 transition-all flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>
                                </button>
                                
                                <input type="number" name="quantity" x-model="qty" class="flex-1 w-full text-center font-bold text-lg text-slate-900 bg-transparent outline-none appearance-none m-0 border-none h-9 p-0" min="1" value="1">
                                
                                <button type="button" @click="qty++" class="w-9 h-9 rounded-full bg-white text-slate-900 shadow-sm border border-gray-100 flex items-center justify-center hover:text-sky-500 hover:border-sky-200 transition-all flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                </button>
                            </div>
                        </div>

                    </div>

                    <div class="flex flex-col md:flex-row gap-4 mb-12 w-full">
                        <button 
                            type="button" 
                            onclick="window.addToCart(this)"
                            class="flex-1 py-4 px-6 font-bold text-sm uppercase tracking-wider transition-all duration-300 rounded-xl border-2 border-slate-900 bg-transparent text-slate-900 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm order-2 md:order-1"
                            {% unless selected_variant.available %}disabled{% endunless %}
                        >
                            {% if selected_variant.available %}Add to Cart{% else %}Sold Out{% endif %}
                        </button>

                        <button 
                            type="button" 
                            onclick="window.buyNow(this)"
                            class="flex-1 py-4 px-6 font-bold text-sm uppercase tracking-wider transition-all duration-300 rounded-xl bg-sky-500 text-white hover:bg-sky-400 shadow-lg hover:shadow-sky-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 order-1 md:order-2"
                            {% unless selected_variant.available %}disabled{% endunless %}
                        >
                            <span>Buy Now</span>
                        </button>
                    </div>
                {% endform %}

                <div class="pt-6 border-t border-gray-100">
                    <h3 class="text-xs font-bold text-slate-900 uppercase tracking-widest mb-6">Specifications</h3>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-6 gap-x-4">
                        {% for attribute in product.metafields.shopify %}
                            {% assign key = attribute.first %}
                            {% assign value = attribute.last %}
                            
                            {% unless key contains 'discovery' or key contains 'search' or key == 'trace_id' %}
                                {% if value != blank %}
                                    <div>
                                        <div class="text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-1">
                                            {{ key | replace: '-', ' ' | replace: '_', ' ' }}
                                        </div>
                                        <div class="text-slate-900 font-medium text-sm">
                                            {% if value.type contains 'list' %}
                                                {% for item in value.value %}
                                                    {{ item.label | default: item.name | default: item }}{% unless forloop.last %}, {% endunless %}
                                                {% endfor %}
                                            {% else %}
                                                {{ value.value.label | default: value.value.name | default: value.value }}
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endunless %}
                        {% endfor %}

                        {% for metafield in product.metafields.custom %}
                            {% assign field_key = metafield | first %}
                            {% assign field_value = metafield | last %}
                            
                            {% if field_value != blank %}
                                <div>
                                    <div class="text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-1">
                                        {{ field_key | replace: '_', ' ' }}
                                    </div>
                                    <div class="text-slate-900 font-medium text-sm">
                                        {% if field_value.type contains 'list' %}
                                             {% for item in field_value.value %}
                                                {{ item.label | default: item.name | default: item }}{% unless forloop.last %}, {% endunless %}
                                             {% endfor %}
                                        {% else %}
                                            {{ field_value.value.label | default: field_value.value.name | default: field_value }}
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}

                        {% for block in section.blocks %}
                            {% if block.type == 'specification_item' and block.settings.content != blank and block.settings.content != 'Connect dynamic source here' %}
                                <div>
                                    <div class="text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-1">
                                        {{ block.settings.heading }}
                                    </div>
                                    <div class="text-slate-900 font-medium text-sm">
                                        {{ block.settings.content }}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                {% for block in section.blocks %}
                    {% if block.type == '@app' %}
                        <div class="mt-8">{% render block %}</div>
                    {% endif %}
                {% endfor %}

            </div>
        </div>
    </div>

    <div class="w-full bg-gray-50 border-t border-gray-100 overflow-hidden">
        <div class="max-w-4xl mx-auto px-4 md:px-8 py-12 md:py-20">
            <h2 class="text-2xl font-bold text-slate-900 mb-8 text-center tracking-tight">Product Details</h2>
            <div class="product-description prose prose-slate mx-auto max-w-none md:prose-lg prose-headings:font-bold prose-a:text-sky-500">
                {{ product.description }}
            </div>
        </div>
    </div>

    <style>
        .selected-variant {
            background-color: #0f172a !important; 
            color: #ffffff !important;
            border-color: #0f172a !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        
        /* RESPONSIVE & OVERFLOW FIXES 
           1. Limit max width of everything to 100% of container
           2. Break long words
           3. Remove radius/margins as requested
        */
        .product-description {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .product-description * {
            max-width: 100% !important;
            box-sizing: border-box;
        }

        .product-description img, 
        .product-description video, 
        .product-description iframe { 
            height: auto !important; 
            margin: 0 auto; 
            display: block; 
            border-radius: 0; 
        }
        
        /* Scrollable table for mobile */
        .product-description table {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>

</div>

<script>
(function() {
    var product = {{ product | json }};
    window.Shopify = window.Shopify || {};
    window.Shopify.money_format = {{ shop.money_format | json }};

    window.initVariantState = function() {
        document.querySelectorAll('.variant-radio').forEach(radio => {
            if(radio.checked) updateVariantStyle(radio);
        });
    };

    window.updateVariantStyle = function(activeRadio) {
        const groupName = activeRadio.name;
        const groupRadios = document.querySelectorAll(`input[name="${groupName}"]`);
        
        groupRadios.forEach(r => {
            const label = document.querySelector(`label[for="${r.id}"]`);
            if(label) {
                label.classList.remove('bg-slate-900', 'text-white', 'shadow-md', 'border-slate-900');
                label.classList.add('bg-white', 'text-slate-700', 'border-gray-200', 'shadow-sm');
            }
        });
        
        const activeLabel = document.querySelector(`label[for="${activeRadio.id}"]`);
        if(activeLabel) {
            activeLabel.classList.remove('bg-white', 'text-slate-700', 'border-gray-200', 'shadow-sm');
            activeLabel.classList.add('bg-slate-900', 'text-white', 'shadow-md');
        }
    };

    window.addToCart = function(btn) {
        const form = document.getElementById('product-form');
        const formData = new FormData(form);
        const originalText = btn.innerHTML;

        btn.innerHTML = 'Adding...';
        btn.disabled = true;

        fetch(window.Shopify.routes.root + 'cart/add.js', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .then(data => {
            btn.innerHTML = 'Added!';
            btn.classList.remove('text-slate-900', 'bg-transparent', 'border-slate-900');
            btn.classList.add('text-white', 'bg-green-600', 'border-green-600');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.classList.add('text-slate-900', 'bg-transparent', 'border-slate-900');
                btn.classList.remove('text-white', 'bg-green-600', 'border-green-600');
            }, 2000);
            
            document.documentElement.dispatchEvent(new CustomEvent('cart:refresh', { bubbles: true, vertical: true }));
        })
        .catch((error) => {
            console.error('Error:', error);
            btn.innerHTML = 'Error';
            setTimeout(() => {
                 btn.innerHTML = originalText;
                 btn.disabled = false;
            }, 2000);
        });
    };

    window.buyNow = function(buyBtn) {
        const form = document.getElementById('product-form');
        const formData = new FormData(form);
        
        buyBtn.innerHTML = '<span>Processing...</span>';
        buyBtn.classList.add('opacity-75');

        fetch(window.Shopify.routes.root + 'cart/add.js', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/checkout';
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            buyBtn.innerHTML = '<span>Buy Now</span>';
            buyBtn.classList.remove('opacity-75');
            alert('Failed to process. Please try again.');
        });
    };

    window.changeImage = function(src, zoomSrc, thumbEl) {
        const mainImg = document.getElementById('MainImage');
        const zoomLens = document.getElementById('ZoomLens');
        if(mainImg) mainImg.src = src;
        if(zoomLens) zoomLens.style.backgroundImage = `url('${zoomSrc}')`;
        const allThumbs = document.querySelectorAll('.thumbnail-item');
        allThumbs.forEach(t => {
            t.classList.remove('ring-2', 'ring-sky-500', 'border-transparent');
            t.classList.add('border-transparent'); 
        });
        if(thumbEl) {
            thumbEl.classList.remove('border-transparent');
            thumbEl.classList.add('ring-2', 'ring-sky-500', 'border-transparent');
        }
    };

    window.handleZoom = function(e) {
        if (window.matchMedia("(hover: none)").matches) return;
        const container = e.currentTarget;
        const lens = container.querySelector('#ZoomLens');
        if (!lens) return;
        const rect = container.getBoundingClientRect();
        let x = ((e.clientX - rect.left) / rect.width) * 100;
        let y = ((e.clientY - rect.top) / rect.height) * 100;
        x = Math.max(0, Math.min(100, x));
        y = Math.max(0, Math.min(100, y));
        lens.style.backgroundPosition = `${x}% ${y}%`;
    };

    window.resetZoom = function(e) {};

    window.Shopify.formatMoney = function(cents, format) {
        if (typeof cents == 'string') { cents = cents.replace('.',''); }
        var value = '';
        var placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;
        var formatString = format || window.Shopify.money_format || "${{amount}}";

        function defaultOption(opt, def) { return (typeof opt == 'undefined' ? def : opt); }
        
        function formatWithDelimiters(number, precision, thousands, decimal) {
            precision = defaultOption(precision, 2);
            thousands = defaultOption(thousands, ',');
            decimal   = defaultOption(decimal, '.');
            if (isNaN(number) || number == null) { return 0; }
            number = (number/100.0).toFixed(precision);
            var parts   = number.split('.'),
                dollars = parts[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1' + thousands),
                cents   = parts[1] ? (decimal + parts[1]) : '';
            return dollars + cents;
        }

        var match = formatString.match(placeholderRegex);
        if (!match) return "$" + (cents/100).toFixed(2);
        switch(match[1]) {
            case 'amount': value = formatWithDelimiters(cents, 2); break;
            case 'amount_no_decimals': value = formatWithDelimiters(cents, 0); break;
            case 'amount_with_comma_separator': value = formatWithDelimiters(cents, 2, '.', ','); break;
            case 'amount_no_decimals_with_comma_separator': value = formatWithDelimiters(cents, 0, '.', ','); break;
        }
        return formatString.replace(placeholderRegex, value);
    };

    document.addEventListener('DOMContentLoaded', function() {
        window.initVariantState();

        document.querySelectorAll('.variant-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                window.updateVariantStyle(this);
                const selectedOptions = Array.from(document.querySelectorAll('.variant-radio:checked')).map(r => r.value);
                const matchedVariant = product.variants.find(variant => {
                    return variant.options.every((val, index) => val === selectedOptions[index]);
                });

                if (matchedVariant) {
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('variant', matchedVariant.id);
                    window.history.replaceState({}, '', newUrl);

                    const variantInput = document.getElementById('VariantIdInput');
                    if(variantInput) variantInput.value = matchedVariant.id;

                    // PRICE & DISCOUNT UPDATE (Stack Layout V3)
                    const priceEl = document.getElementById('ProductPrice');
                    if(priceEl) {
                        let priceHtml = `<div class="flex items-center gap-3 md:gap-4">`;
                        priceHtml += `<span class="text-3xl md:text-4xl font-bold text-slate-900 leading-none tracking-tight">${window.Shopify.formatMoney(matchedVariant.price, window.Shopify.money_format)}</span>`;
                        
                        if(matchedVariant.compare_at_price > matchedVariant.price) {
                             const discountPercent = Math.round((1 - (matchedVariant.price / matchedVariant.compare_at_price)) * 100);
                             
                             priceHtml += `
                                <div class="flex flex-col items-start justify-center space-y-1">
                                    <span class="text-xs font-bold px-2 py-0.5 rounded-md leading-tight" style="background-color: #FEF2F2 !important; color: #DC2626 !important; border: 1px solid #FECACA;">
                                        -${discountPercent}% OFF
                                    </span>
                                    <span class="text-sm text-gray-400 font-medium leading-none" style="text-decoration: line-through !important;">
                                        ${window.Shopify.formatMoney(matchedVariant.compare_at_price, window.Shopify.money_format)}
                                    </span>
                                </div>
                             `;
                        }
                        priceHtml += `</div>`;
                        priceEl.innerHTML = priceHtml;
                    }
                    
                    if (matchedVariant.featured_media) {
                        const mediaId = matchedVariant.featured_media.id;
                        const targetThumb = document.querySelector(`.thumbnail-item[data-media-id="${mediaId}"]`);
                        if (targetThumb) {
                            targetThumb.click();
                        } else {
                            const imgSrc = matchedVariant.featured_media.preview_image.src;
                            const highResUrl = imgSrc.replace(/(\.[^.]*)$/, '_1000x$1'); 
                            const zoomUrl = imgSrc.replace(/(\.[^.]*)$/, '_2000x$1');
                            window.changeImage(highResUrl, zoomUrl, null);
                        }
                    }
                }
            });
        });
    });

})();
</script>